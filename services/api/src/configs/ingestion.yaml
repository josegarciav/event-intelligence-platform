# Configuration for Ingestion Pipelines
# This file defines which sources are enabled, their settings,
# scheduling, and source-specific configuration.

sources:

  # =========================================================================
  # RA.CO - GraphQL API-based ingestion
  # =========================================================================
  ra_co:
    enabled: true
    pipeline_type: "api"

    # Connection settings
    connection:
      endpoint: "https://ra.co/graphql"
      protocol: "graphql"
      timeout_seconds: 30

    # Legacy settings (for backwards compatibility)
    graphql_endpoint: "https://ra.co/graphql"
    request_timeout: 30
    max_retries: 3
    batch_size: 50
    rate_limit_per_second: 1.0

    # GraphQL Query Configuration
    query:
      template: |
        query GetEvents($filters: FilterInputDtoInput, $pageSize: Int, $page: Int) {
          eventListings(filters: $filters, pageSize: $pageSize, page: $page) {
            data {
              id
              event {
                id
                title
                content
                date
                startTime
                endTime
                attending
                isTicketed
                venue {
                  name
                  address
                  live
                  area {
                    name
                    country {
                      name
                      urlCode
                    }
                  }
                }
                artists {
                  name
                }
                images {
                  filename
                  crop
                }
                cost
                contentUrl
              }
            }
            totalResults
          }
        }
      variables:
        filters:
          areas:
            eq: "{{area_id}}"
          listingDate:
            gte: "{{date_from}}"
            lte: "{{date_to}}"
        pageSize: "{{page_size}}"
        page: "{{page}}"
      response_path: "data.eventListings.data"
      total_results_path: "data.eventListings.totalResults"

    # Pagination
    pagination:
      type: "page_number"
      max_pages: 10
      default_page_size: 50

    # Field mappings: target_field -> source_path
    field_mappings:
      source_event_id: "event.id"
      title: "event.title"
      description: "event.content"
      date: "event.date"
      start_time: "event.startTime"
      end_time: "event.endTime"
      venue_name: "event.venue.name"
      venue_address: "event.venue.address"
      city: "event.venue.area.name"
      country_name: "event.venue.area.country.name"
      country_code: "event.venue.area.country.urlCode"
      artists: "event.artists[*].name"
      cost: "event.cost"
      content_url: "event.contentUrl"
      image_filename: "event.images[0].filename"
      image_crop: "event.images[0].crop"
      venue_live: "event.venue.live"
      attending: "event.attending"
      is_ticketed: "event.isTicketed"

    # Transformations applied after field extraction
    transformations:
      description:
        type: "strip_html"
        source: "description"
      image_url:
        type: "template"
        template: "https://ra.co/images/events/flyer/{{image_filename}}"
        when: "image_filename"
      source_url:
        type: "template"
        template: "https://ra.co{{content_url}}"
      country_code:
        type: "uppercase"

    # Taxonomy mapping rules
    taxonomy_suggestions:
      default_primary: "1" # Play & Pure Fun
      default_subcategory: "1.4"  # Music & Rhythm Play

    # Event type determination rules
    event_type_rules:
      - match:
          title_contains: ["festival"]
        type: "festival"
      - match:
          title_contains: ["party", "fiesta"]
        type: "party"
      - match:
          title_contains: ["live", "concert", "gig"]
        type: "concert"
      - match:
          title_contains: ["workshop", "masterclass"]
        type: "workshop"
      - default: true
        type: "nightlife"

    # Default values
    defaults:
      page_size: 100
      days_ahead: 120
      areas:
        Barcelona: 20
        Madrid: 41
      location:
        cities: [ "Barcelona", "Madrid" ]
        country_code: "ES"
        timezone: "Europe/Madrid"

    # Validation rules
    validation:
      required_fields: ["title", "source_event_id", "city", "start_datetime"]
      future_events_only: true

    # Enrichment options
    enrichment:
      geocoding: true
      compressed_html:
        enabled: true
        engine_type: hybrid
        rate_limit_per_second: 2.0
        timeout_s: 15.0
      # Feature extraction (LLM-based)
      feature_extraction:
        enabled: false
        provider: "openai"
        model_name: "gpt-4o-mini"
        fill_missing:
          - "event_type"
          - "tags"
          - "activity_id"
          - "activity_name"
          - "energy_level"
          - "social_intensity"
          - "cognitive_load"
          - "physical_involvement"
          - "cost_level"
          - "time_scale"
          - "environment"
          - "emotional_output"
          - "risk_level"
          - "age_accessibility"
          - "repeatability"
          - "event_type"
          - "capacity"
          - "event_format"
          - "tags"

    # Scheduling
    schedule:
      type: "cron" # cron | interval | manual
      interval_hours: 6
      cron_expression: "0 */6 * * *"  # Every 6 hours
      enabled: false

  # =========================================================================
  # TICKETMASTER - REST API-based ingestion
  # =========================================================================
  ticketmaster:
    enabled: false
    pipeline_type: "api"

    # Connection settings
    connection:
      endpoint: "https://app.ticketmaster.com/discovery/v2/events.json"
      protocol: "rest"
      timeout_seconds: 30

    max_retries: 3
    rate_limit_per_second: 5.0

    # REST Query Configuration
    query:
      params:
        apikey: "${TICKETMASTER_API_KEY}"
        city: "{{city}}"
        countryCode: "{{country_code}}"
        startDateTime: "{{date_from}}T00:00:00Z"
        endDateTime: "{{date_to}}T23:59:59Z"
        size: "{{page_size}}"
        page: "{{page}}"
        sort: "date,asc"
      response_path: "_embedded.events"
      total_results_path: "page.totalElements"

    # Pagination
    pagination:
      type: "page_number"
      max_pages: 5
      default_page_size: 50

    # Field mappings: target_field -> source_path
    field_mappings:
      source_event_id: "id"
      title: "name"
      description: "info"
      date: "dates.start.localDate"
      start_time: "dates.start.dateTime"
      end_time: "dates.end.dateTime"
      venue_name: "_embedded.venues[0].name"
      venue_address: "_embedded.venues[0].address.line1"
      city: "_embedded.venues[0].city.name"
      country_code: "_embedded.venues[0].country.countryCode"
      content_url: "url"
      image_url_raw: "images[0].url"
      cost_min: "priceRanges[0].min"
      cost_max: "priceRanges[0].max"
      cost_currency: "priceRanges[0].currency"

    # Transformations applied after field extraction
    transformations:
      source_url:
        type: "template"
        template: "{{content_url}}"
      image_url:
        type: "template"
        template: "{{image_url_raw}}"
        when: "image_url_raw"
      description:
        type: "strip_html"
        source: "description"

    # Taxonomy mapping rules
    taxonomy_suggestions:
      default_primary: "1"  # Play & Pure Fun
      default_subcategory: "1.4"  # Music & Rhythm Play

    # Event type determination rules
    event_type_rules:
      - match:
          title_contains: ["festival"]
        type: "festival"
      - match:
          title_contains: ["concert", "live", "tour"]
        type: "concert"
      - match:
          title_contains: ["workshop", "masterclass"]
        type: "workshop"
      - match:
          title_contains: ["comedy", "stand-up"]
        type: "theater"
      - match:
          title_contains: ["exhibition", "exhibit"]
        type: "exhibition"
      - default: true
        type: "other"

    # Default values
    defaults:
      page_size: 50
      days_ahead: 120
      country_code: "ES"
      cities: ["Barcelona", "Madrid"]
      location:
        country_code: "ES"
        timezone: "Europe/Madrid"

    # Validation rules
    validation:
      required_fields: ["title", "source_event_id"]
      future_events_only: true

    # Enrichment options
    enrichment:
      geocoding: true
      compressed_html:
        enabled: false
        engine_type: hybrid
        rate_limit_per_second: 2.0
        timeout_s: 15.0
      # Feature extraction (LLM-based)
      feature_extraction:
        enabled: false

    # Scheduling
    schedule:
      type: "cron"
      interval_hours: 12
      cron_expression: "0 */12 * * *"  # Every 12 hours
      enabled: false

# =========================================================================
# GLOBAL SETTINGS
# =========================================================================

global:
  # Storage settings
  storage:
    type: "postgresql"
    url: "${DATABASE_URL}"
    pool_size: 10
    max_overflow: 20

  # Logging
  logging:
    level: "INFO"
    format: "json"
    file: "logs/ingestion.log"

  # Data quality
  quality_thresholds:
    minimum_quality_score: 0.3
    timezone_confidence: 0.7

  # Deduplication
  deduplication:
    enabled: true
    strategy: "exact"  # exact | fuzzy | metadata | composite

  # Enrichment services (optional)
  enrichment_services:
    geocoding:
      provider: "google"
      api_key: "${GEOCODING_API_KEY}"
      cache_ttl_hours: 720

    image_validation:
      timeout: 5
      check_accessibility: true

  # Monitoring & alerts (observability)
  observability:
    sentry_enabled: false
    sentry_dsn: "${SENTRY_DSN}"

    slack_enabled: false
    slack_webhook: "${SLACK_WEBHOOK}"

    alert_on:
      - "pipeline_failure"
      - "data_quality_breach"
      - "deduplication_rate_high"
      - "ingestion_delay"
      - "missing_required_fields"
      - "low_quality_score"
      - "api_error_rate_high"
